---
layout: lab
title: Temperature (Absolute)
---
<iframe id="lab-model" width="610px" height="450px" frameborder="0"
        src="http://lab.concord.org/embeddable.html#interactives/sam/gas-laws/5-temperature-pressure-relationship.json">
</iframe>

<div id="debug">
  <div id="state-and-plotter">
    <div id="state-msg"></div>
    <div id="plotter"></div>
  </div>
  <div id="hands-view"></div>
</div>

<script>
  $(function () {
    // Setup debug hand view.
    Leap.loop().use('boneHand', {
      targetEl: $('#hands-view')[0],
      width: 299,
      height: 299
    });

    // Setup plotter.
    var plotter = new Plotter({el: $('#plotter')[0]});

    // Setup Lab communication.
    var targetTemperature = null;
    var iframe = $('#lab-model')[0];
    var phone = new iframePhone.ParentEndpoint(iframe);
    phone.addListener('modelLoaded', function setObserver () {
      phone.post('play');
    });

    // Leap works only when window is active.
    // We can easily loose focus when when user interacts with Lab model.
    setInterval(function () {
      window.focus();
    }, 500);

    // Define gestures.
    processLeapGestures({
      'initial': {
        info: 'Please keep your hands steady above the Leap device.',
        action: function () {
          // Clear data if user totally removes hand from Leap POV. It ensures that when he starts gesture again,
          // we won't have old data that can initially be interpreted as part of the new gesture. It could have been
          // added as a part of other, non-final states too. But it's possible that we get back to other states
          // due to Leap inaccuracy, while this one is pretty reliable.
          avg.clear('fistXPosAvg');
        },
        nextState: function (frame) {
          if (frame.hands.length === 2) {
            return 'two-hands-detected';
          }
          // Hide debug data.
          plotter.showCanvas(null);
          return null;
        }
      },
      'two-hands-detected': {
        info: 'Close one fist and twist the other hand.',
        nextState: function (frame) {
          function condition(closedHandIdx, openHandIdx) {
            var closedHand = frame.hands[closedHandIdx];
            var openHand = frame.hands[openHandIdx];
            if (closedHand.grabStrength > 0.6 && openHand.grabStrength < 0.6 && // hand fist is closed
                Math.abs(Math.abs(openHand.roll()) - Math.PI / 2) < 0.5) {      // open palm is twisted
              return true;
            }
            return false;
          }

          if (condition(0, 1)) {
            return {stateId: 'gesture-detected', data: {closedHand: frame.hands[0], openHand: frame.hands[1]}};
          } else if (condition(1, 0)) {
            return {stateId: 'gesture-detected', data: {closedHand: frame.hands[1], openHand: frame.hands[0]}};
          } else {
            plotter.showCanvas('two-hands-detected');
            plotter.plot('hand 0 roll', frame.hands[0].roll());
            plotter.plot('hand 1 grab strength', frame.hands[1].grabStrength);
            plotter.update()
          }
          return null;
        }
      },
      'gesture-detected': {
        info: '<p>Move your closed fist towards open palm and back rapidly to increase the temperature. ' +
              'Do it slowly to decrease the temperature.</p>',
        action: function (frame, data) {
          var hand = data.closedHand;
          avg.addSample('fistXPos', hand.palmPosition[0], 6);
          avg.addSample('fistXPosAvg', avg.getAvg('fistXPos'), 500);
          avg.addSample('fistFreq', avg.getFreq('fistXPosAvg', 20), 40);
          var fistFreq = avg.getAvg('fistFreq');

          plotter.showCanvas('gesture-detected');
          plotter.plot('closed fist X pos', hand.palmPosition[0]);
          plotter.plot('closed fist X pos (avg)', avg.getAvg('fistXPos'));
          plotter.plot('closed fist X frequency (avg)', fistFreq);
          plotter.update();

          if (fistFreq > 0) {
            phone.post('set', { name: 'targetTemperature', value: fistFreq * 250 });
          }
        }
      }
    });
  });
</script>
