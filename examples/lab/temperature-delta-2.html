---
layout: lab
title: Temperature (Delta)
---
<iframe id="lab-model" width="610px" height="450px" frameborder="0"
        src="http://lab.concord.org/embeddable.html#interactives/sam/gas-laws/5-temperature-pressure-relationship.json">
</iframe>

<div id="debug">
  <div id="state-and-plotter">
    <div id="state-msg"></div>
    <div id="plotter"></div>
  </div>
  <div id="hands-view"></div>
</div>

<script>
  $(function () {
    // Setup debug hand view.
    Leap.loop().use('boneHand', {
      targetEl: $('#hands-view')[0],
      width: 299,
      height: 299
    });

    // Setup plotter.
    var plotter = new Plotter({el: $('#plotter')[0]});

    // Setup Lab communication.
    var targetTemperature = null;
    var iframe = $('#lab-model')[0];
    var phone = new iframePhone.ParentEndpoint(iframe);
    phone.addListener('modelLoaded', function setObserver () {
      phone.post('play');
      phone.post('observe', 'targetTemperature');
    });
    phone.addListener('propertyValue', function (data) {
      if (data.name == 'targetTemperature') {
        targetTemperature = data.value;
      }
    });

    // Leap works only when window is active.
    // We can easily loose focus when when user interacts with Lab model.
    setInterval(function () {
      window.focus();
    }, 500);

    // Define gestures.
    var conf = {
      closedGrabStrength: 0.4,
      openGrabStrength: 0.7,
      handTwistTolerance: 0.7,
      minAmplitude: 30
    };
    processLeapGestures({
      'initial': {
        info: 'Please keep your hands steady above the Leap device.',
        nextState: function (frame) {
          if (frame.hands.length === 2) {
            return 'two-hands-detected';
          }
          // Hide debug data.
          plotter.showCanvas(null);
          return null;
        }
      },
      'two-hands-detected': {
        info: 'Close one fist and twist the other hand.',
        nextState: function (frame) {
          function condition(closedHandIdx, openHandIdx) {
            var closedHand = frame.hands[closedHandIdx];
            var openHand = frame.hands[openHandIdx];
            if (closedHand.grabStrength > conf.closedGrabStrength && openHand.grabStrength < conf.openGrabStrength &&
                Math.abs(Math.abs(openHand.roll()) - Math.PI / 2) < conf.handTwistTolerance) {
              return true;
            }
            return false;
          }

          if (condition(0, 1)) {
            return {stateId: 'gesture-detected', data: {closedHand: frame.hands[0], openHand: frame.hands[1]}};
          } else if (condition(1, 0)) {
            return {stateId: 'gesture-detected', data: {closedHand: frame.hands[1], openHand: frame.hands[0]}};
          } else {
            plotter.showCanvas('two-hands-detected');
            plotter.plot('hand 0 roll', frame.hands[0].roll());
            plotter.plot('hand 1 grab strength', frame.hands[1].grabStrength);
            plotter.update()
          }
          return null;
        }
      },
      'gesture-detected': {
        info: '<p>Move your closed fist towards open palm and back rapidly to increase the temperature (> 1.7Hz). ' +
              'Do it slowly to decrease the temperature (< 1.2Hz).</p>',
        nextState: function (frame, data) {
          var hand = data.closedHand;
          avg.addSample('fistXVel', hand.palmVelocity[0], 6);
          avg.addSample('fistXVelAvg', avg.getAvg('fistXVel'), 500);
          avg.addSample('fistFreq', avg.getFreqFromVel('fistXVelAvg', conf.minAmplitude), 6);
          var fistFreq = avg.getAvg('fistFreq');

          plotter.showCanvas('gesture-detected');
          plotter.plot('closed fist X vel (avg)', avg.getAvg('fistXVel'));
          plotter.plot('closed fist X frequency', fistFreq);
          plotter.update();

          if (fistFreq > 1.7) {
            return 'temp-increasing';
          } else if (fistFreq < 1.2 && fistFreq > 0) {
            return 'temp-decreasing';
          }
          // Do nothing when freq is between 1.2 and 1.7 or equal to 0.
          return null;
        }
      },
      'temp-increasing': {
        info: 'Temperature is increasing (frequency > 1.7Hz).',
        action: function () {
          plotter.showCanvas('gesture-detected');
          // Send msg to Lab model.
          var newTemp = Math.min(1000, targetTemperature + 2);
          phone.post('set', { name: 'targetTemperature', value: newTemp });
        }
      },
      'temp-decreasing': {
        info: 'Temperature is decreasing (frequency < 1.2Hz).',
        action: function () {
          plotter.showCanvas('gesture-detected');
          // Send msg to Lab model.
          var newTemp = Math.max(0, targetTemperature - 2);
          phone.post('set', { name: 'targetTemperature', value: newTemp });
        }
      }
    });
  });
</script>
