---
layout: lab
title: Temperature (Delta)
---
<iframe id="lab-model" width="610px" height="350px" frameborder="0"
        src="http://lab.concord.org/embeddable.html#interactives/grasp/temperature-pressure-relationship.json">
</iframe>

<div id="debug">
  <div id="state-and-plotter">
    <div id="state-msg"></div>
    <div id="plotter"></div>
  </div>
  <div id="hands-view"></div>
</div>

<script>
  $(function () {
    // Setup debug hand view.
    Leap.loop().use('boneHand', {
      targetEl: $('#hands-view')[0],
      width: 299,
      height: 299
    });

    // Setup plotter.
    var plotter = new Plotter({el: $('#plotter')[0]});

    // Setup Lab communication.
    var targetTemperature = null;
    var iframe = $('#lab-model')[0];
    var phone = new iframePhone.ParentEndpoint(iframe);
    phone.addListener('modelLoaded', function setObserver () {
      phone.post('play');
      phone.post('observe', 'targetTemperature');
    });
    phone.addListener('propertyValue', function (data) {
      if (data.name == 'targetTemperature') {
        targetTemperature = data.value;
      }
    });

    // Leap works only when window is active.
    // We can easily loose focus when when user interacts with Lab model.
    setInterval(function () {
      window.focus();
    }, 500);

    // Define gestures.
    var conf = {
      closedGrabStrength: 0.4,
      openGrabStrength: 0.7,
      handTwistTolerance: 0.7,
      velAvg1: 100,
      velAvg2: 20,
      tempIncreaseVel: 600,
      tempDecreaseVel: 300
    };
    var gui = new dat.GUI();
    gui.add(conf, 'tempIncreaseVel', 0, 1000);
    gui.add(conf, 'tempDecreaseVel', 0, 1000);
    processLeapGestures({
      'initial': {
        info: 'Please keep your hands steady above the Leap device.',
        nextState: function (frame) {
          if (frame.hands.length === 2) {
            return 'two-hands-detected';
          }
          // Hide debug data.
          plotter.showCanvas(null);
          return null;
        }
      },
      'two-hands-detected': {
        info: 'Close one fist and twist the other hand.',
        nextState: function (frame) {
          function condition(closedHandIdx, openHandIdx) {
            var closedHand = frame.hands[closedHandIdx];
            var openHand = frame.hands[openHandIdx];
            if (closedHand.grabStrength > conf.closedGrabStrength && openHand.grabStrength < conf.openGrabStrength &&
                Math.abs(Math.abs(openHand.roll()) - Math.PI / 2) < conf.handTwistTolerance) {
              return true;
            }
            return false;
          }

          if (condition(0, 1)) {
            return {stateId: 'gesture-detected', data: {closedHand: frame.hands[0], openHand: frame.hands[1]}};
          } else if (condition(1, 0)) {
            return {stateId: 'gesture-detected', data: {closedHand: frame.hands[1], openHand: frame.hands[0]}};
          } else {
            plotter.showCanvas('two-hands-detected');
            plotter.plot('hand 0 roll', frame.hands[0].roll());
            plotter.plot('hand 1 grab strength', frame.hands[1].grabStrength);
            plotter.update()
          }
          return null;
        }
      },
      'gesture-detected': {
        info: function () {
              return '<p>Move your closed fist towards open palm and back rapidly to increase the temperature (velocity > '
                     + Math.round(conf.tempIncreaseVel) + '). Do it slowly to decrease the temperature (velocity < ' + Math.round(conf.tempDecreaseVel) + ').</p>';
        },
        nextState: function (frame, data) {
          var hand = data.closedHand;
          avg.addSample('fistVel', vec3.len(hand.palmVelocity), conf.velAvg1);
          avg.addSample('fistVelAvg', avg.getAvg('fistVel'), conf.velAvg2);
          var vel = avg.getAvg('fistVelAvg');

          plotter.showCanvas('gesture-detected');
          plotter.plot('closed fist vel (avg)', vel);
          plotter.update();

          if (vel > conf.tempIncreaseVel) {
            return 'temp-increasing';
          } else if (vel < conf.tempDecreaseVel) {
            return 'temp-decreasing';
          }
          // Do nothing when freq is between 1.2 and 1.7 or equal to 0.
          return null;
        }
      },
      'temp-increasing': {
        info: function () { return 'Temperature is increasing (velocity > ' + Math.round(conf.tempIncreaseVel) + ').'; },
        action: function () {
          plotter.showCanvas('gesture-detected');
          // Send msg to Lab model.
          var newTemp = Math.min(5000, targetTemperature + 10);
          phone.post('set', { name: 'targetTemperature', value: newTemp });
        }
      },
      'temp-decreasing': {
        info: function () { return 'Temperature is decreasing (velocity < ' + Math.round(conf.tempDecreaseVel) + ').'; },
        action: function () {
          plotter.showCanvas('gesture-detected');
          // Send msg to Lab model.
          var newTemp = Math.max(0, targetTemperature - 10);
          phone.post('set', { name: 'targetTemperature', value: newTemp });
        }
      }
    });
  });
</script>
