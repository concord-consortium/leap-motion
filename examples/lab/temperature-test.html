---
layout: lab
title: Temperature test
---

<div id="debug">
  <div id="state-and-plotter">
    <div id="state-msg"></div>
    <div id="plotter"></div>
  </div>
  <div id="hands-view"></div>
</div>

<script>
  $(function () {
    // Setup debug hand view.
    Leap.loop().use('boneHand', {
      targetEl: $('#hands-view')[0],
      width: 299,
      height: 299
    });

    // Setup plotter.
    var plotter = new Plotter({el: $('#plotter')[0]});

    // Sound.
    var sound = new Howl({
      src: ['tap.wav']
    });

    // Config
    var config = {
      closedGrabStrength: 0.4,
      openGrabStrength: 0.7,
      handTwistTolerance: 0.7,
      minAmplitude: 5,
      freqAvg: 120,
      maxVelAvg: 120
    };

    // Frequency calculator
    var lastDirChange = null;
    var freq = 0;
    var maxVel = 0;
    var freqCalc = new DirectionChange({
      minAmplitude: config.minAmplitude,
      onDirChange: function (newMaxVel) {
        var timestamp = Date.now();
        if (lastDirChange) {
          freq = 0.5 * 1000 / (timestamp - lastDirChange);
          maxVel = newMaxVel;
        }
        lastDirChange = timestamp;
        // Play sound effect!
        sound.play();
      },
      onStop: function () {
        lastDirChange = Date.now();
        freq = 0;
        maxVel = 0;
      }
    });

    // GUI
    var gui = new dat.GUI();
    gui.add(config, 'closedGrabStrength', 0, 1);
    gui.add(config, 'openGrabStrength', 0, 1);
    gui.add(config, 'handTwistTolerance', 0, 1);
    gui.add(freqCalc.options, 'minAmplitude', 0, 200);
    gui.add(config, 'maxVelAvg', 0, 500);
    gui.add(config, 'freqAvg', 0, 500);

    // Define gestures.
    processLeapGestures({
      'initial': {
        info: 'Please keep your hands steady above the Leap device.',
        nextState: function (frame) {
          if (frame.hands.length === 2) {
            return 'two-hands-detected';
          }
          // Hide debug data.
          plotter.showCanvas(null);
          return null;
        }
      },
      'two-hands-detected': {
        info: 'Close one fist and twist the other hand.',
        nextState: function (frame) {
          function condition(closedHandIdx, openHandIdx) {
            var closedHand = frame.hands[closedHandIdx];
            var openHand = frame.hands[openHandIdx];
            if (closedHand.grabStrength > config.closedGrabStrength && openHand.grabStrength < config.openGrabStrength &&
                Math.abs(Math.abs(openHand.roll()) - Math.PI / 2) < config.handTwistTolerance) {
              return true;
            }
            return false;
          }

          if (condition(0, 1)) {
            return {stateId: 'gesture-detected', data: {closedHand: frame.hands[0], openHand: frame.hands[1]}};
          } else if (condition(1, 0)) {
            return {stateId: 'gesture-detected', data: {closedHand: frame.hands[1], openHand: frame.hands[0]}};
          } else {
            plotter.showCanvas('two-hands-detected');
            plotter.plot('hand 0 roll', frame.hands[0].roll());
            plotter.plot('hand 1 grab strength', frame.hands[1].grabStrength);
            plotter.update()
          }
          return null;
        }
      },
      'gesture-detected': {
        info: '<p>Move your closed fist towards open palm and back rapidly.</p>',
        action: function (frame, data) {
          plotter.showCanvas('gesture-detected');

          var hand = data.closedHand;

          avg.addSample('fistXVel1', vec3.len(hand.palmVelocity), 100);
          avg.addSample('fistXVel2', avg.getAvg('fistXVel1'), 20);
          plotter.plot('velocity avg', avg.getAvg('fistXVel2'), {min: 0, max: 1300, precision: 2});

          avg.addSample('fistXVel', hand.palmVelocity[0], 6);
          freqCalc.addSample(avg.getAvg('fistXVel'), hand.stabilizedPalmPosition[0]);
          avg.addSample('newFreq', freq, Math.round(config.freqAvg));
          avg.addSample('maxVel', maxVel, Math.round(config.maxVelAvg));
          plotter.plot('max velocity avg', avg.getAvg('maxVel'), {min: 0, max: 1500, precision: 2});
          plotter.plot('frequency (new alg)', avg.getAvg('newFreq'), {min: 0, max: 6, precision: 2});

          plotter.update();

          return null;
        }
      }
    });
  });
</script>
