---
layout: lab
title: Frequency calculated using velocity or position
---

<div id="debug">
  <div id="state-and-plotter">
    <div id="state-msg"></div>
    <div id="plotter"></div>
  </div>
  <div id="hands-view"></div>
</div>

<script>
  $(function () {
    // Setup debug hand view.
    Leap.loop().use('boneHand', {
      targetEl: $('#hands-view')[0],
      width: 299,
      height: 299
    });

    // Setup plotter.
    var plotter = new Plotter({el: $('#plotter')[0], height: 200});

    // Config
    var config = {
      closedGrabStrength: 0.4,
      openGrabStrength: 0.7,
      handTwistTolerance: 0.7,
      posMinAmplitude: 10,
      velMinAmplitude: 30,
      freqAvg: 6
    };
    var gui = new dat.GUI();
    gui.add(config, 'closedGrabStrength', 0, 1);
    gui.add(config, 'openGrabStrength', 0, 1);
    gui.add(config, 'handTwistTolerance', 0, 1);
    gui.add(config, 'posMinAmplitude', 0, 100);
    gui.add(config, 'velMinAmplitude', 0, 100);
    gui.add(config, 'freqAvg', 0, 100);
    gui.add(avg, 'FREQ_MIN_COUNT', 0, 20);
    gui.add(avg, 'FREQ_MIN_TIME', 0, 3000);

    // Define gestures.
    processLeapGestures({
      'initial': {
        info: 'Please keep your hands steady above the Leap device.',
        nextState: function (frame) {
          if (frame.hands.length === 2) {
            return 'two-hands-detected';
          }
          // Hide debug data.
          plotter.showCanvas(null);
          return null;
        }
      },
      'two-hands-detected': {
        info: 'Close one fist and twist the other hand.',
        nextState: function (frame) {
          function condition(closedHandIdx, openHandIdx) {
            var closedHand = frame.hands[closedHandIdx];
            var openHand = frame.hands[openHandIdx];
            if (closedHand.grabStrength > config.closedGrabStrength && openHand.grabStrength < config.openGrabStrength &&
                Math.abs(Math.abs(openHand.roll()) - Math.PI / 2) < config.handTwistTolerance) {
              return true;
            }
            return false;
          }

          if (condition(0, 1)) {
            return {stateId: 'gesture-detected', data: {closedHand: frame.hands[0], openHand: frame.hands[1]}};
          } else if (condition(1, 0)) {
            return {stateId: 'gesture-detected', data: {closedHand: frame.hands[1], openHand: frame.hands[0]}};
          } else {
            plotter.showCanvas('two-hands-detected');
            plotter.plot('hand 0 roll', frame.hands[0].roll());
            plotter.plot('hand 1 grab strength', frame.hands[1].grabStrength);
            plotter.update()
          }
          return null;
        }
      },
      'gesture-detected': {
        info: '<p>Move your closed fist towards open palm and back rapidly.</p>',
        action: function (frame, data) {
          var hand = data.closedHand;

          avg.addSample('fistXVel1', vec3.len(hand.palmVelocity), 150);
          avg.addSample('fistXVel2', avg.getAvg('fistXVel1'), 10);
          var velAvg1 = avg.getAvg('fistXVel2');

          avg.addSample('fistXVel3', vec3.len(hand.palmVelocity), 200);
          avg.addSample('fistXVel4', avg.getAvg('fistXVel3'), 20);
          var velAvg2 = avg.getAvg('fistXVel4');

          avg.addSample('fistXVel', hand.palmVelocity[0], 6);
          avg.addSample('fistXVelAvg', avg.getAvg('fistXVel'), 500);
          avg.addSample('fistFreqVel', avg.getFreqFromVel('fistXVelAvg', config.velMinAmplitude), Math.round(config.freqAvg));
          var fistFreqFromVel = avg.getAvg('fistFreqVel');

          avg.addSample('fistXPos', hand.palmPosition[0], 6);
          avg.addSample('fistXPosAvg', avg.getAvg('fistXPos'), 500);
          avg.addSample('fistFreqPos', avg.getFreq('fistXPosAvg', config.posMinAmplitude), Math.round(config.freqAvg));
          var fistFreqFromPos = avg.getAvg('fistFreqPos');

          plotter.showCanvas('gesture-detected');
          plotter.plot('X velocity avg', velAvg1);
          plotter.plot('X velocity (stronger smoothing)', velAvg2);
          plotter.plot('frequency (based on X velocity)', fistFreqFromVel);
          plotter.plot('frequency (based on X position)', fistFreqFromPos);
          plotter.update();

          return null;
        }
      }
    });
  });
</script>
